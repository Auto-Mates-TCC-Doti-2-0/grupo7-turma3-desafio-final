pipeline {
    agent any
    
    stages {
        stage('Git Checkout') {
            steps {
                git credentialsId: 'git-ssh-private-key',
                    url: 'git@github.com:Auto-Mates-TCC-Doti-2-0/grupo7-turma3-desafio-final.git', 
                    branch: 'main'
            }
        }
        stage('Constroi instancia EC2 Template') {
            steps {
                sh "02-pipeline-AMI/deploy.sh"
            }
        }
        stage('Faz o build da nova AMI') {
            steps {
                script {
                    // def ami_id = sh returnStdout: true, script "02-pipeline-AMI/build-ami.sh"
                    // echo ami_id
                    sh "02-pipeline-AMI/build-ami.sh"
                }
            }
        }
        stage('Valida AMI na AWS') {
            steps {
                script {
                    def versao = sh "git describe --tags \$(git rev-list --tags --max-count=1)"
                    echo "Validando AMI vers√£o ${versao}"
                    sh 'aws ec2 describe-images | grep "\"Name\":*${versao}"'
                }
            }
        }
        stage('Destroi instancia EC2 template') {
            steps {
                sh "02-pipeline-AMI/destroy.sh"
            }
        }
    }
}
